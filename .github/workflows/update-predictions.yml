name: Daily FPL Predictions Update

"on":
  schedule:
    # Run daily at 9 AM UTC (you can adjust this)
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  update-predictions:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required to push changes
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run FPL predictions
      run: |
        echo "ðŸš€ Starting FPL predictions update..."
        python FPL.py
        echo "âœ… Predictions generated successfully"
        
    - name: Create last updated timestamp
      run: |
        echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC')" > last_updated.txt
        echo "Last updated: $(cat last_updated.txt)"
        
    - name: Create latest.csv symlink copy
      run: |
        latest_gw=$(ls -1 gameweek_*_predictions.csv | awk -F_ '{print $2}' | sort -n | tail -1)
        cp "gameweek_${latest_gw}_predictions.csv" latest.csv
        echo "Using gameweek ${latest_gw} as latest.csv"

    - name: Build static predictions.json
      run: |
        python - << 'PY'
        import glob, os, csv, json, time
        latest = sorted(glob.glob('gameweek_*_predictions.csv'), key=lambda p:int(os.path.basename(p).split('_')[1]))[-1]
        with open(latest, newline='') as f:
            rows = list(csv.DictReader(f))
        numeric = {'predicted_points','now_cost','points_per_game','form','total_points',
                   'expected_goals','minutes','assists','goals_scored','yellow_cards',
                   'red_cards','saves_per_90','clean_sheets','opponent_difficulty'}
        for r in rows:
            for k in list(r):
                if k in numeric:
                    try:
                        r[k] = float(r[k])
                    except:
                        r[k] = 0.0
        gameweek = int(os.path.basename(latest).split('_')[1])
        os.makedirs('frontend/public', exist_ok=True)
        out = {
          "gameweek": gameweek,
          "csv_file": os.path.basename(latest),
          "total_players": len(rows),
          "filtered_players": len(rows),
          "last_updated": time.strftime("%Y-%m-%d %H:%M:%S UTC", time.gmtime()),
          "players": rows
        }
        with open('frontend/public/predictions.json','w') as f: json.dump(out, f)
        PY
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # Add all CSV files, latest.csv, predictions.json, and timestamp
        git add gameweek_*_predictions.csv latest.csv frontend/public/predictions.json last_updated.txt
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ¤– Daily FPL predictions update: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          git push
          echo "âœ… Changes pushed successfully"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Trigger Vercel deployment
      run: |
        echo "ðŸš€ Triggering Vercel deployment..."
        # The push will automatically trigger Vercel deployment
